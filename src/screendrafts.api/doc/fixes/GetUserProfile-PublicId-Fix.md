# Fix for GetUserProfileTests.Should_ReturnOk_WhenUserExistsAsync Failure

## Problem
The test was failing with HTTP 500 Internal Server Error because the `PublicId` claim was missing from JWT tokens generated by Keycloak. When the GetUserProfile endpoint called `User.GetPublicId()`, it threw a `ScreenDraftsException` because the claim was unavailable.

## Root Cause
1. During user registration, a `PublicId` was generated and stored in the database
2. However, the `PublicId` was NOT being sent to Keycloak as a user attribute
3. Keycloak generated JWT tokens without the `public_id` claim
4. The GetUserProfile endpoint requires this claim to identify the user

## Code Changes Implemented

### 1. UserRepresentation.cs
Added `Attributes` property to support custom user attributes:
```csharp
internal sealed record UserRepresentation(
    string Username,
    string Email,
    string FirstName,
    string LastName,
    bool Enabled,
    bool EmailVerified,
    CredentialRepresentation[] Credentials,
    Dictionary<string, List<string>>? Attributes = null);
```

### 2. UserModel.cs
Added optional `PublicId` parameter:
```csharp
public sealed record UserModel(
  string Email,
  string Password,
  string FirstName,
  string LastName,
  string? PublicId = null);
```

### 3. IdentityProviderService.cs
Updated to send `public_id` attribute to Keycloak:
```csharp
var attributes = user.PublicId is not null
  ? new Dictionary<string, List<string>>
  {
    ["public_id"] = [user.PublicId]
  }
  : null;

var userRepresentation = new UserRepresentation(
  user.Email,
  user.Email,
  user.FirstName,
  user.LastName,
  true,
  true,
  [new CredentialRepresentation(PasswordCredentialType, user.Password, false)],
  attributes);
```

### 4. RegisterUserCommandHandler.cs
Generate `PublicId` BEFORE calling Keycloak registration:
```csharp
var publicId = _publicIdGenerator.GeneratePublicId(PublicIdPrefixes.User);

var identityResult = await _identityProviderService.RegisterUserAsync(
  new UserModel(
    emailValue!,
    request.Password,
    firstNameValue!,
    lastNameValue!,
    publicId),
  cancellationToken);
```

## Required Keycloak Configuration

⚠️ **IMPORTANT**: The code changes alone are not sufficient. Keycloak must be configured to include the `public_id` user attribute as a claim in JWT tokens.

### Option 1: Update Realm Export File
Add the following protocol mapper to the `screendrafts-public` client in `screendrafts-realm-export.json`:

```json
{
  "name": "public_id-mapper",
  "protocol": "openid-connect",
  "protocolMapper": "oidc-usermodel-attribute-mapper",
  "consentRequired": false,
  "config": {
    "userinfo.token.claim": "true",
    "user.attribute": "public_id",
    "id.token.claim": "true",
    "access.token.claim": "true",
    "claim.name": "public_id",
    "jsonType.label": "String"
  }
}
```

### Option 2: Manual Configuration (for existing realms)
1. Log into Keycloak Admin Console
2. Navigate to: Realm → Clients → screendrafts-public
3. Go to the "Client Scopes" tab
4. Select the appropriate scope (e.g., "screendrafts-public-dedicated")
5. Go to "Mappers" tab
6. Click "Add mapper" → "By configuration" → "User Attribute"
7. Configure:
   - Name: `public_id-mapper`
   - User Attribute: `public_id`
   - Token Claim Name: `public_id`
   - Claim JSON Type: String
   - Add to ID token: ON
   - Add to access token: ON
   - Add to userinfo: ON

## Testing the Fix
After implementing both the code changes and Keycloak configuration:

1. Run the integration test:
   ```bash
   dotnet test --filter "FullyQualifiedName~GetUserProfileTests.Should_ReturnOk_WhenUserExistsAsync"
   ```

2. The test should now pass with HTTP 200 OK instead of HTTP 500

## Related Files
- `src/modules/users/ScreenDrafts.Modules.Users.Infrastructure/Identity/UserRepresentation.cs`
- `src/modules/users/ScreenDrafts.Modules.Users.Domain/Abstractions/Identity/UserModel.cs`
- `src/modules/users/ScreenDrafts.Modules.Users.Infrastructure/Identity/IdentityProviderService.cs`
- `src/modules/users/ScreenDrafts.Modules.Users.Features/Users/Register/RegisterUserCommandHandler.cs`
- `src/modules/users/ScreenDrafts.Modules.Users.IntegrationTests/Abstractions/screendrafts-realm-export.json` (needs update)
