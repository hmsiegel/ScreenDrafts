// <auto-generated />
using System;

using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace ScreenDrafts.Modules.Drafts.Infrastructure.Database.Migrations
{
  /// <inheritdoc />
  public partial class UpdateHostsAndCoHosts : Migration
  {
    /// <inheritdoc />
    protected override void Up(MigrationBuilder migrationBuilder)
    {
      migrationBuilder.CreateTable(
          name: "draft_hosts",
          schema: "drafts",
          columns: table => new
          {
            draft_id = table.Column<Guid>(type: "uuid", nullable: false),
            host_id = table.Column<Guid>(type: "uuid", nullable: false),
            role = table.Column<int>(type: "integer", nullable: false),
          },
          constraints: table =>
          {
            table.PrimaryKey("pk_draft_hosts", x => new { x.draft_id, x.host_id });
            table.ForeignKey(
                      name: "fk_draft_hosts_drafts_draft_id",
                      column: x => x.draft_id,
                      principalSchema: "drafts",
                      principalTable: "drafts",
                      principalColumn: "id",
                      onDelete: ReferentialAction.Cascade);
            table.ForeignKey(
                      name: "fk_draft_hosts_hosts_host_id",
                      column: x => x.host_id,
                      principalSchema: "drafts",
                      principalTable: "hosts",
                      principalColumn: "id",
                      onDelete: ReferentialAction.Restrict);
          });

      migrationBuilder.Sql(
        """
        WITH ranked AS (
          SELECT
            dh.hosted_drafts_id,
            dh.hosts_id,
            ROW_NUMBER() OVER (PARTITION BY dh.hosted_drafts_id ORDER BY dh.hosts_id) AS rn
          FROM
            drafts.draft_host dh
        )
        INSERT INTO drafts.draft_hosts (draft_id, host_id, role)
        SELECT
          r.hosted_drafts_id AS draft_id,
          r.hosts_id AS host_id,
          CASE WHEN r.rn = 1 THEN 0 ELSE 1 END AS role
        FROM
          ranked r
        """
        );

      migrationBuilder.CreateIndex(
          name: "ix_draft_hosts_host_id",
          schema: "drafts",
          table: "draft_hosts",
          column: "host_id");

      migrationBuilder.CreateIndex(
          name: "ux_draft_hosts_one_primary_per_draft",
          schema: "drafts",
          table: "draft_hosts",
          column: "draft_id",
          unique: true,
          filter: "role = 0");

      migrationBuilder.DropTable(
          name: "draft_host",
          schema: "drafts");
    }

    /// <inheritdoc />
    protected override void Down(MigrationBuilder migrationBuilder)
    {
      migrationBuilder.CreateTable(
          name: "draft_host",
          schema: "drafts",
          columns: table => new
          {
            hosted_drafts_id = table.Column<Guid>(type: "uuid", nullable: false),
            hosts_id = table.Column<Guid>(type: "uuid", nullable: false)
          },
          constraints: table =>
          {
            table.PrimaryKey("pk_draft_host", x => new { x.hosted_drafts_id, x.hosts_id });
            table.ForeignKey(
                      name: "fk_draft_host_drafts_hosted_drafts_id",
                      column: x => x.hosted_drafts_id,
                      principalSchema: "drafts",
                      principalTable: "drafts",
                      principalColumn: "id",
                      onDelete: ReferentialAction.Cascade);
            table.ForeignKey(
                      name: "fk_draft_host_hosts_hosts_id",
                      column: x => x.hosts_id,
                      principalSchema: "drafts",
                      principalTable: "hosts",
                      principalColumn: "id",
                      onDelete: ReferentialAction.Cascade);
          });

      migrationBuilder.Sql(
        """
        INSERT INTO drafts.draft_host (hosted_drafts_id, hosts_id)
        SELECT
          dh.draft_id AS hosted_drafts_id,
          dh.host_id AS hosts_id
        FROM
          drafts.draft_hosts dh
        """
        );

      migrationBuilder.CreateIndex(
          name: "ix_draft_host_hosts_id",
          schema: "drafts",
          table: "draft_host",
          column: "hosts_id");

      migrationBuilder.DropTable(
          name: "draft_hosts",
          schema: "drafts");
    }
  }
}
