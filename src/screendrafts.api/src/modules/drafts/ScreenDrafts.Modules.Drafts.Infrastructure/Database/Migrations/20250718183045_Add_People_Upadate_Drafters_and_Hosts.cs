// <auto-generated />

#nullable disable

namespace ScreenDrafts.Modules.Drafts.Infrastructure.Database.Migrations
{
  /// <inheritdoc />
  public partial class Add_People_Upadate_Drafters_and_Hosts : Migration
  {
    /// <inheritdoc />
    protected override void Up(MigrationBuilder migrationBuilder)
    {
      // 1. Create people table
      migrationBuilder.CreateTable(
          name: "people",
          schema: "drafts",
          columns: table => new
          {
            id = table.Column<Guid>(type: "uuid", nullable: false),
            user_id = table.Column<Guid>(type: "uuid", nullable: true),
            first_name = table.Column<string>(type: "text", nullable: false),
            last_name = table.Column<string>(type: "text", nullable: false),
            display_name = table.Column<string>(type: "text", nullable: true)
          },
          constraints: table =>
          {
            table.PrimaryKey("pk_people", x => x.id);
          });

      // 2. Update drafters and hosts tables to reference people
      migrationBuilder.AddColumn<Guid>(
          name: "person_id",
          schema: "drafts",
          table: "hosts",
          type: "uuid",
          defaultValue: new Guid("00000000-0000-0000-0000-000000000000"));

      migrationBuilder.AddColumn<Guid>(
          name: "person_id",
          schema: "drafts",
          table: "drafters",
          type: "uuid",
          defaultValue: new Guid("00000000-0000-0000-0000-000000000000"));

      // 3. Insert unique names into People table
      migrationBuilder.Sql(
        """
        WITH AllNames AS (
            SELECT DISTINCT host_name AS display_name FROM drafts.hosts
            UNION
            SELECT DISTINCT name AS display_name FROM drafts.drafters
        ),
        SplitNames AS (
            SELECT 
                display_name,
                regexp_replace(display_name, '\s+[^ ]+$', '') AS first_name,
                split_part(display_name, ' ', array_length(string_to_array(display_name, ' '), 1)) AS last_name
            FROM AllNames
        )
        INSERT INTO drafts.people (id, first_name, last_name, display_name)
        SELECT 
            gen_random_uuid() AS id,
            first_name,
            last_name,
            display_name
        FROM SplitNames
        WHERE display_name IS NOT NULL AND display_name <> '';
        """);

      // 4. Update drafters and hosts to reference people
      migrationBuilder.Sql(
        """
        UPDATE drafts.hosts
        SET person_id = p.id
        FROM drafts.people p
        WHERE drafts.hosts.host_name = p.display_name
        """);

      migrationBuilder.Sql(
        """
        UPDATE drafts.drafters
        SET person_id = p.id
        FROM drafts.people p
        WHERE drafts.drafters.name = p.display_name;
        """);

      // 5. Remove old columns and create new indexes
      migrationBuilder.DropColumn(
          name: "host_name",
          schema: "drafts",
          table: "hosts");

      migrationBuilder.DropColumn(
          name: "user_id",
          schema: "drafts",
          table: "hosts");

      migrationBuilder.DropColumn(
          name: "name",
          schema: "drafts",
          table: "drafters");

      migrationBuilder.DropColumn(
          name: "user_id",
          schema: "drafts",
          table: "drafters");

      // 6. Make person_id non-nullable
      migrationBuilder.AlterColumn<Guid>(
          name: "person_id",
          schema: "drafts",
          table: "hosts",
          type: "uuid",
          nullable: false,
          oldClrType: typeof(Guid),
          oldType: "uuid",
          oldNullable: true);

      migrationBuilder.AlterColumn<Guid>(
          name: "person_id",
          schema: "drafts",
          table: "drafters",
          type: "uuid",
          nullable: false,
          oldClrType: typeof(Guid),
          oldType: "uuid",
          oldNullable: true);

      // 6. Create indexes on person_id in drafters and hosts
      migrationBuilder.CreateIndex(
          name: "ix_hosts_person_id",
          schema: "drafts",
          table: "hosts",
          column: "person_id",
          unique: true);

      migrationBuilder.CreateIndex(
          name: "ix_drafters_person_id",
          schema: "drafts",
          table: "drafters",
          column: "person_id",
          unique: true);

      // 7. Add foreign keys to drafters and hosts referencing people
      migrationBuilder.AddForeignKey(
          name: "fk_drafters_people_person_id",
          schema: "drafts",
          table: "drafters",
          column: "person_id",
          principalSchema: "drafts",
          principalTable: "people",
          principalColumn: "id",
          onDelete: ReferentialAction.Cascade);

      migrationBuilder.AddForeignKey(
          name: "fk_hosts_people_person_id",
          schema: "drafts",
          table: "hosts",
          column: "person_id",
          principalSchema: "drafts",
          principalTable: "people",
          principalColumn: "id",
          onDelete: ReferentialAction.Cascade);
    }

    /// <inheritdoc />
    protected override void Down(MigrationBuilder migrationBuilder)
    {
      migrationBuilder.DropForeignKey(
          name: "fk_drafters_people_person_id",
          schema: "drafts",
          table: "drafters");

      migrationBuilder.DropForeignKey(
          name: "fk_hosts_people_person_id",
          schema: "drafts",
          table: "hosts");

      migrationBuilder.DropTable(
          name: "people",
          schema: "drafts");

      migrationBuilder.DropIndex(
          name: "ix_hosts_person_id",
          schema: "drafts",
          table: "hosts");

      migrationBuilder.DropIndex(
          name: "ix_drafters_person_id",
          schema: "drafts",
          table: "drafters");

      migrationBuilder.DropColumn(
          name: "person_id",
          schema: "drafts",
          table: "hosts");

      migrationBuilder.DropColumn(
          name: "person_id",
          schema: "drafts",
          table: "drafters");

      migrationBuilder.AddColumn<string>(
          name: "host_name",
          schema: "drafts",
          table: "hosts",
          type: "text",
          nullable: false,
          defaultValue: "");

      migrationBuilder.AddColumn<Guid>(
          name: "user_id",
          schema: "drafts",
          table: "hosts",
          type: "uuid",
          nullable: true);

      migrationBuilder.AddColumn<string>(
          name: "name",
          schema: "drafts",
          table: "drafters",
          type: "character varying(100)",
          maxLength: 100,
          nullable: false,
          defaultValue: "");

      migrationBuilder.AddColumn<Guid>(
          name: "user_id",
          schema: "drafts",
          table: "drafters",
          type: "uuid",
          nullable: true);
    }
  }
}
